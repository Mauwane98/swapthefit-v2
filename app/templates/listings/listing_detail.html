{# app/templates/listings/listing_detail.html #}
{% extends "_layouts/base.html" %}

{% block title %}{{ listing.title }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="bg-white rounded-xl shadow-2xl overflow-hidden md:flex">
        {# Image Section #}
        <div class="md:w-1/2 p-6 flex items-center justify-center bg-gray-50">
            <img src="{{ url_for('static', filename='uploads/' + listing.image_file) }}"
                 alt="{{ listing.title }}"
                 class="max-w-full h-auto rounded-lg shadow-md object-cover max-h-[500px]">
        </div>

        {# Details Section #}
        <div class="md:w-1/2 p-8">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-4">{{ listing.title }}</h1>
            <p class="text-gray-700 text-lg mb-6 leading-relaxed">{{ listing.description }}</p>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                <div class="detail-item">
                    <span class="font-semibold text-gray-800">Listing Type:</span>
                    <span class="text-indigo-600 font-medium">{{ listing.listing_type|capitalize }}</span>
                </div>
                {% if listing.listing_type == 'sale' %}
                <div class="detail-item">
                    <span class="font-semibold text-gray-800">Price:</span>
                    <span class="text-green-700 font-bold text-xl">R{{ "%.2f"|format(listing.price) }}</span>
                </div>
                {% endif %}
                <div class="detail-item">
                    <span class="font-semibold text-gray-800">Condition:</span>
                    <span class="text-gray-600">{{ listing.condition }}</span>
                </div>
                <div class="detail-item">
                    <span class="font-semibold text-gray-800">Size:</span>
                    <span class="text-gray-600">{{ listing.size }}</span>
                </div>
                <div class="detail-item">
                    <span class="font-semibold text-gray-800">Gender:</span>
                    <span class="text-gray-600">{{ listing.gender }}</span>
                </div>
                <div class="detail-item">
                    <span class="font-semibold text-gray-800">Uniform Type:</span>
                    <span class="text-gray-600">{{ listing.uniform_type }}</span>
                </div>
                {% if listing.school_name %}
                <div class="detail-item">
                    <span class="font-semibold text-gray-800">School:</span>
                    <span class="text-gray-600">{{ listing.school_name }}</span>
                </div>
                {% endif %}
                <div class="detail-item">
                    <span class="font-semibold text-gray-800">Location:</span>
                    <span class="text-gray-600">{{ listing.location }}</span>
                </div>
                {% if listing.brand %}
                <div class="detail-item">
                    <span class="font-semibold text-gray-800">Brand:</span>
                    <span class="text-gray-600">{{ listing.brand }}</span>
                </div>
                {% endif %}
                {% if listing.color %}
                <div class="detail-item">
                    <span class="font-semibold text-gray-800">Color:</span>
                    <span class="text-gray-600">{{ listing.color }}</span>
                </div>
                {% endif %}
                <div class="detail-item col-span-full">
                    <span class="font-semibold text-gray-800">Posted By:</span>
                    <a href="{{ url_for('listings.user_profile', user_id=listing.user.id) }}" class="text-blue-600 hover:underline">
                        {{ listing.user.username }}
                    </a> on {{ listing.date_posted.strftime('%b %d, %Y') }}
                </div>
            </div>

            {# Action Buttons #}
            <div class="mt-8 flex flex-col sm:flex-row sm:space-x-4 space-y-4 sm:space-y-0">
                {% if listing.user != current_user %}
                    {# Message User Button #}
                    <a href="{{ url_for('messaging.inbox', user_id=listing.user.id) }}"
                       class="flex-1 text-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200 shadow-md">
                        Message {{ listing.user.username }}
                    </a>

                    {# Add/Remove from Wishlist Button #}
                    {% if current_user.is_authenticated %}
                        {% if in_wishlist %}
                            <form action="{{ url_for('wishlist.remove_from_wishlist', listing_id=listing.id) }}" method="POST" class="flex-1">
                                <button type="submit"
                                        class="w-full text-center bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200 shadow-md">
                                    Remove from Wishlist
                                </button>
                            </form>
                        {% else %}
                            <form action="{{ url_for('wishlist.add_to_wishlist', listing_id=listing.id) }}" method="POST" class="flex-1">
                                <button type="submit"
                                        class="w-full text-center bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200 shadow-md">
                                    Add to Wishlist
                                </button>
                            </form>
                        {% endif %}
                    {% endif %}

                    {# Propose Swap/Donation/Purchase - Placeholder for future full integration #}
                    {% if listing.listing_type == 'swap' %}
                        <a href="{{ url_for('swaps.propose_swap', listing_id=listing.id) }}"
                           class="flex-1 text-center bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200 shadow-md">
                            Propose Swap
                        </a>
                    {% elif listing.listing_type == 'donation' %}
                        <a href="{{ url_for('donations.propose_donation', listing_id=listing.id) }}"
                           class="flex-1 text-center bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200 shadow-md">
                            Request Donation
                        </a>
                    {% elif listing.listing_type == 'sale' %}
                         <a href="{{ url_for('payments.process_payment', listing_id=listing.id|string) }}"
                           class="flex-1 text-center bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200 shadow-md">
                            Buy Now
                        </a>
                    {% endif %}

                    {# Raise Dispute Button #}
                    {% if current_user.is_authenticated %}
                        <a href="{{ url_for('disputes.raise_dispute', respondent_id=listing.user.id, listing_id=listing.id) }}"
                           class="flex-1 text-center bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200 shadow-md">
                            Raise Dispute
                        </a>
                    {% endif %}

                    {# Report Listing Button #}
                    {% if current_user.is_authenticated %}
                        <a href="{{ url_for('reports.submit_report', entity_type='listing', entity_id=listing.id|string) }}"
                           class="flex-1 text-center bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200 shadow-md">
                            Report Listing
                        </a>
                    {% endif %}

                {% else %}
                    {# Options for the owner of the listing #}
                    <a href="{{ url_for('listings.edit_listing', listing_id=listing.id) }}"
                       class="flex-1 text-center bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200 shadow-md">
                        Edit Listing
                    </a>
                    <form action="{{ url_for('listings.delete_listing', listing_id=listing.id) }}" method="POST" class="flex-1">
                        <button type="submit"
                                class="w-full text-center bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200 shadow-md"
                                onclick="return confirm('Are you sure you want to delete this listing? This action cannot be undone.');">
                            Delete Listing
                        </button>
                    </form>
                {% endif %}
            </div>
        </div>
    </div>
</div>
<style>
    .detail-item {
        @apply flex flex-col sm:flex-row sm:items-center;
    }
    .detail-item span:first-child {
        @apply sm:w-1/3; /* Adjust as needed for label width */
    }
</style>
{% endblock %}
