{% extends "_layouts/base.html" %}

{% block title %}{{ user.username }}'s Profile{% endblock %}

{% block content %}
<style>
    /*
     * Custom styles for the User Profile page, consistent with other pages.
     */
    :root {
        --primary-color: #4f46e5;
        --secondary-color: #7c3aed;
        --text-dark: #1f2937;
        --text-gray: #4b5563;
        --bg-light: #f9fafb;
        --font-sans: 'Inter', sans-serif;
    }

    body {
        font-family: var(--font-sans);
    }

    .card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border-radius: 1rem;
        background-color: white;
        padding: 2.5rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    .review-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border-radius: 0.75rem;
        background-color: white;
        padding: 1.5rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    }
    
    .rating-star-filled {
        color: #f59e0b; /* Tailwind yellow-500 */
    }

    .rating-star-empty {
        color: #d1d5db; /* Tailwind gray-300 */
    }

    .action-button {
        transition: background-color 0.3s ease, transform 0.3s ease;
        border-radius: 0.5rem;
        font-weight: 600;
        padding: 0.75rem 1rem;
        display: inline-block;
        text-align: center;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        background-color: var(--primary-color);
        color: white;
    }

    .action-button:hover {
        background-color: #4338ca;
        transform: scale(1.01);
    }
</style>

<div class="container mx-auto px-4 py-12">
    <!-- User Profile Header -->
    <div class="card mb-8">
        <div class="flex items-center space-x-6">
            <div class="flex-shrink-0">
                <!-- User Avatar - Placeholder -->
                <div class="w-20 h-20 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 text-3xl font-bold">
                    {{ user.username[0]|upper }}
                </div>
            </div>
            <div>
                <h1 class="text-3xl font-bold text-gray-800">{{ user.username }}</h1>
                <p class="text-gray-600">{{ user.email }}</p>
                <div class="flex items-center mt-2">
                    <span class="text-lg font-semibold text-gray-700 mr-2">{{ avg_rating|round(1) }}/5</span>
                    <div class="flex">
                        {% for i in range(5) %}
                            {% if i < avg_rating|round(1)|int %}
                                <svg class="w-6 h-6 fill-current rating-star-filled" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                            {% else %}
                                <svg class="w-6 h-6 fill-current rating-star-empty" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <span class="text-gray-600 ml-2">({{ reviews|length }} reviews)</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="bg-{{ 'green' if category == 'success' else ('red' if category == 'danger' else 'blue') }}-100 border border-{{ 'green' if category == 'success' else ('red' if category == 'danger' else 'blue') }}-400 text-{{ 'green' if category == 'success' else ('red' if category == 'danger' else 'blue') }}-700 px-4 py-3 rounded relative mb-4" role="alert">
                    <span class="block sm:inline">{{ message }}</span>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- User's Listings -->
    <div class="mb-12">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">{{ user.username }}'s Listings</h2>
        {% if listings %}
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                {% for listing in listings %}
                <div class="bg-white rounded-lg shadow-md overflow-hidden transform hover:-translate-y-1 transition-all duration-300">
                    <a href="{{ url_for('listings.listing_detail', listing_id=listing.id) }}">
                        <img src="{{ url_for('static', filename='uploads/' + listing.image_url) if listing.image_url else 'https://placehold.co/600x400/d1d5db/374151?text=No+Image' }}" alt="{{ listing.item_name }}" class="w-full h-48 object-cover lazy-load" onerror="this.onerror=null;this.src='https://placehold.co/600x400/d1d5db/374151?text=No+Image';">
                    </a>
                    <div class="p-4">
                        <h3 class="text-lg font-semibold text-gray-800 truncate">{{ listing.item_name }}</h3>
                        <p class="text-gray-600 text-sm mb-2">{{ listing.school_name }}</p>
                        <p class="text-gray-800 font-bold mt-2">R{{ "%.2f"|format(listing.price) }}</p>
                        <div class="mt-4 flex justify-between items-center">
                            <a href="{{ url_for('listings.listing_detail', listing_id=listing.id) }}" class="text-indigo-600 hover:text-indigo-800 font-semibold text-sm">View Details</a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-gray-600">{{ user.username }} has no active listings.</p>
        {% endif %}
    </div>

    <!-- Reviews Section -->
    <div>
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Reviews</h2>

        <!-- Submit a Review Form -->
        {% if current_user.is_authenticated and current_user.id != user.id and not has_reviewed %}
        <div class="review-card mb-8">
            <h3 class="text-xl font-semibold mb-4">Leave a Review for {{ user.username }}</h3>
            <form action="{{ url_for('reviews.add_review', user_id=user.id) }}" method="POST" class="space-y-4">
                {{ review_form.hidden_tag() }}
                <div>
                    <label for="rating-input" class="block text-gray-700 font-bold mb-2">Rating:</label>
                    <div class="flex items-center" id="star-rating">
                        {% for i in range(1, 6) %}
                        <svg class="w-8 h-8 cursor-pointer fill-current rating-star-empty star" data-value="{{ i }}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                        {% endfor %}
                    </div>
                    {{ review_form.rating(class="hidden", id="rating-input") }}
                    <p id="rating-error" class="text-red-500 text-xs mt-1 hidden">Please select a rating.</p>
                </div>
                <div>
                    {{ review_form.comment.label(class="block text-gray-700 font-bold mb-2") }}
                    {{ review_form.comment(id="comment-input", class="w-full p-2 border rounded form-input", rows="4") }}
                    <p id="comment-error" class="text-red-500 text-xs mt-1 hidden">A comment is required.</p>
                </div>
                <div>
                    <button type="submit" class="action-button w-full">Submit Review</button>
                </div>
            </form>
        </div>
        {% elif current_user.is_authenticated and current_user.id != user.id and has_reviewed %}
        <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-8" role="alert">
            <p>You have already submitted a review for this user.</p>
        </div>
        {% endif %}

        <!-- Display Reviews -->
        {% if reviews %}
            <div class="space-y-6">
                {% for review in reviews %}
                <div class="review-card">
                    <div class="flex items-center mb-2">
                        <div class="flex">
                             {% for i in range(5) %}
                                {% if i < review.rating %}
                                    <svg class="w-5 h-5 fill-current rating-star-filled" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                                {% else %}
                                    <svg class="w-5 h-5 fill-current rating-star-empty" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <p class="ml-4 font-semibold text-gray-800">{{ review.reviewer.username }}</p>
                    </div>
                    <p class="text-gray-600">{{ review.comment }}</p>
                    <p class="text-xs text-gray-400 mt-2 text-right">{{ review.date_posted.strftime('%B %d, %Y') }}</p>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-gray-600">This user has no reviews yet.</p>
        {% endif %}
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const stars = document.querySelectorAll('#star-rating .star');
        const ratingInput = document.getElementById('rating-input');
        const reviewForm = document.querySelector('form[action*="add_review"]');
        const ratingError = document.getElementById('rating-error');
        const commentInput = document.getElementById('comment-input');
        const commentError = document.getElementById('comment-error');

        // Star rating functionality
        stars.forEach(star => {
            star.addEventListener('click', function() {
                const value = parseInt(this.getAttribute('data-value'));
                ratingInput.value = value;
                ratingError.classList.add('hidden'); // Clear error on interaction
                
                stars.forEach(s => {
                    if (parseInt(s.getAttribute('data-value')) <= value) {
                        s.classList.remove('rating-star-empty');
                        s.classList.add('rating-star-filled');
                    } else {
                        s.classList.remove('rating-star-filled');
                        s.classList.add('rating-star-empty');
                    }
                });
            });
        });

        // Form submission validation
        if (reviewForm) {
            reviewForm.addEventListener('submit', (e) => {
                let isFormValid = true;

                // Validate rating
                if (!ratingInput.value) {
                    ratingError.classList.remove('hidden');
                    isFormValid = false;
                } else {
                    ratingError.classList.add('hidden');
                }

                // Validate comment
                if (!commentInput.value.trim()) {
                    commentError.classList.remove('hidden');
                    isFormValid = false;
                } else {
                    commentError.classList.add('hidden');
                }

                if (!isFormValid) {
                    e.preventDefault();
                }
            });
        }
    });
</script>
{% endblock %}
