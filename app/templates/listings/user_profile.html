{% extends "_layouts/base.html" %}

{% block title %}{{ user.username }}'s Profile{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">

    <!-- User Profile Header -->
    <div class="bg-white p-6 rounded-lg shadow-md mb-8">
        <h1 class="text-3xl font-bold text-gray-800">{{ user.username }}</h1>
        <p class="text-gray-600">{{ user.email }}</p>
        <div class="flex items-center mt-4">
            <span class="text-lg font-semibold text-gray-700 mr-2">{{ avg_rating }}/5</span>
            <div class="flex text-yellow-400">
                {% for i in range(5) %}
                    {% if i < avg_rating|round|int %}
                        <svg class="w-6 h-6 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                    {% else %}
                        <svg class="w-6 h-6 fill-current text-gray-300" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                    {% endif %}
                {% endfor %}
            </div>
            <span class="text-gray-600 ml-2">({{ reviews|length }} reviews)</span>
        </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="bg-{{ 'green' if category == 'success' else ('red' if category == 'danger' else 'blue') }}-100 border border-{{ 'green' if category == 'success' else ('red' if category == 'danger' else 'blue') }}-400 text-{{ 'green' if category == 'success' else ('red' if category == 'danger' else 'blue') }}-700 px-4 py-3 rounded relative mb-4" role="alert">
                    <span class="block sm:inline">{{ message }}</span>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- User's Listings -->
    <div class="mb-12">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">{{ user.username }}'s Listings</h2>
        {% if listings %}
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                {% for listing in listings %}
                <div class="bg-white rounded-lg shadow-md overflow-hidden transform hover:-translate-y-1 transition-all duration-300">
                    <a href="{{ url_for('listings.listing_detail', listing_id=listing.id) }}">
                        <img src="{{ url_for('static', filename='uploads/' + listing.image_url) if listing.image_url else 'https://placehold.co/600x400/d1d5db/374151?text=No+Image' }}" alt="{{ listing.item_name }}" class="w-full h-48 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/600x400/d1d5db/374151?text=No+Image';">
                    </a>
                    <div class="p-4">
                        <h3 class="text-lg font-semibold text-gray-800">{{ listing.item_name }}</h3>
                        <p class="text-gray-600 text-sm">{{ listing.school_name }}</p>
                        <p class="text-gray-800 font-bold mt-2">R{{ "%.2f"|format(listing.price) }}</p>
                        <div class="mt-4 flex justify-between items-center">
                            <a href="{{ url_for('listings.listing_detail', listing_id=listing.id) }}" class="text-indigo-600 hover:text-indigo-800 font-semibold text-sm">View Details</a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-gray-600">{{ user.username }} has no active listings.</p>
        {% endif %}
    </div>

    <!-- Reviews Section -->
    <div>
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Reviews</h2>

        <!-- Submit a Review Form -->
        {% if current_user.is_authenticated and current_user.id != user.id and not has_reviewed %}
        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h3 class="text-xl font-semibold mb-4">Leave a Review for {{ user.username }}</h3>
            <form action="{{ url_for('reviews.add_review', user_id=user.id) }}" method="POST">
                {{ review_form.hidden_tag() }}
                <div class="mb-4">
                    <label for="rating" class="block text-gray-700 font-bold mb-2">Rating:</label>
                    <div class="flex items-center" id="star-rating">
                        {% for i in range(1, 6) %}
                        <svg class="w-8 h-8 cursor-pointer text-gray-300 star" data-value="{{ i }}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                        {% endfor %}
                    </div>
                    {{ review_form.rating(class="hidden", id="rating-input") }}
                </div>
                <div class="mb-4">
                    {{ review_form.comment.label(class="block text-gray-700 font-bold mb-2") }}
                    {{ review_form.comment(class="w-full p-2 border rounded", rows="4") }}
                </div>
                <div>
                    {{ review_form.submit(class="bg-indigo-600 text-white font-bold py-2 px-4 rounded hover:bg-indigo-700 transition-colors") }}
                </div>
            </form>
        </div>
        {% elif current_user.is_authenticated and current_user.id != user.id and has_reviewed %}
        <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-8" role="alert">
            <p>You have already submitted a review for this user.</p>
        </div>
        {% endif %}

        <!-- Display Reviews -->
        {% if reviews %}
            <div class="space-y-6">
                {% for review in reviews %}
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex items-center mb-2">
                        <div class="flex text-yellow-400">
                             {% for i in range(5) %}
                                {% if i < review.rating %}
                                    <svg class="w-5 h-5 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                                {% else %}
                                    <svg class="w-5 h-5 fill-current text-gray-300" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <p class="ml-4 font-semibold text-gray-800">{{ review.reviewer.username }}</p>
                    </div>
                    <p class="text-gray-600">{{ review.comment }}</p>
                    <p class="text-xs text-gray-400 mt-2 text-right">{{ review.date_posted.strftime('%B %d, %Y') }}</p>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-gray-600">This user has no reviews yet.</p>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const stars = document.querySelectorAll('#star-rating .star');
    const ratingInput = document.getElementById('rating-input');

    stars.forEach(star => {
        star.addEventListener('click', function() {
            const value = this.getAttribute('data-value');
            ratingInput.value = value;
            
            stars.forEach(s => {
                if (s.getAttribute('data-value') <= value) {
                    s.classList.remove('text-gray-300');
                    s.classList.add('text-yellow-400');
                } else {
                    s.classList.remove('text-yellow-400');
                    s.classList.add('text-gray-300');
                }
            });
        });
    });
});
</script>
{% endblock %}
