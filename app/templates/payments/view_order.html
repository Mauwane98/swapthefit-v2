{% extends '_layouts/base.html' %}
{% import 'macros.html' as macros %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-2xl">
    <div class="bg-white p-8 rounded-lg shadow-xl border border-gray-200">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Order Details</h1>

        <div class="mb-8 p-4 bg-gray-50 rounded-md border border-gray-100">
            <p class="text-lg font-semibold text-gray-700 mb-2">Item: <span class="text-indigo-600">{{ order.purchased_listing.title }}</span></p>
            <div class="flex items-center space-x-4 mb-4">
                <img src="{{ order.purchased_listing.images[0] }}" alt="{{ order.purchased_listing.title }}" class="w-24 h-24 object-cover rounded-md shadow-md">
                <div>
                    <p class="text-sm text-gray-600">Size: {{ order.purchased_listing.size }}</p>
                    <p class="text-sm text-gray-600">Condition: {{ order.purchased_listing.condition }}</p>
                    <p class="text-sm text-gray-600">Category: {{ order.purchased_listing.category }}</p>
                    {% if order.purchased_listing.school_name %}<p class="text-sm text-gray-600">School: {{ order.purchased_listing.school_name }}</p>{% endif %}
                </div>
            </div>
            <p class="text-sm text-gray-700 mb-2">Description: {{ order.purchased_listing.description }}</p>
            <p class="text-lg font-bold text-green-700 mt-4">Price: R {{ "%.2f" | format(order.price_at_purchase) }}</p>
        </div>

        <div class="mb-8 p-4 bg-blue-50 rounded-md border border-blue-100">
            <h2 class="text-xl font-semibold text-blue-800 mb-3">Transaction Details</h2>
            <p class="text-md text-gray-700 mb-2">Buyer: <span class="font-medium">{{ order.buyer.username }}</span></p>
            <p class="text-md text-gray-700 mb-2">Seller: <span class="font-medium">{{ order.seller.username }}</span></p>
            <p class="text-md text-gray-700 mb-2">Order Status: 
                <span class="font-bold {% if order.status == 'pending_payment' %}text-yellow-600{% elif order.status == 'paid' or order.status == 'pending_pickup' %}text-blue-600{% elif order.status == 'completed' %}text-green-600{% elif order.status == 'cancelled' %}text-red-600{% endif %}">
                    {{ order.status|replace('_', ' ')|capitalize }}
                </span>
            </p>
            {% if order.transaction_id %}<p class="text-md text-gray-700 mb-2">Transaction ID: <span class="font-medium">{{ order.transaction_id }}</span></p>{% endif %}
            <p class="text-sm text-gray-600">Order Date: {{ moment(order.order_date).format('MMMM Do YYYY, h:mm a') }}</p>
            {% if order.updated_date %}<p class="text-sm text-gray-600">Last Updated: {{ moment(order.updated_date).format('MMMM Do YYYY, h:mm a') }}</p>{% endif %}
        </div>

        <!-- Actions -->
        <div class="mt-6 flex flex-col space-y-4">
            {% if current_user.id == order.buyer.id %}
                <!-- Buyer Actions -->
                {% if order.status == 'pending_payment' %}
                    <a href="{{ url_for('payments.process_payment', order_id=order.id) }}"
                       class="w-full inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        <i class="fas fa-credit-card mr-2"></i> Complete Payment
                    </a>
                {% elif order.status == 'pending_pickup' %}
                    <form action="{{ url_for('payments.complete_order', order_id=order.id) }}" method="POST">
                        {{ csrf_token() }}
                        <button type="submit" class="w-full inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                            <i class="fas fa-check-circle mr-2"></i> Confirm Item Received
                        </button>
                    </form>
                {% endif %}
                {% if order.status in ['pending_payment', 'paid', 'pending_pickup'] %}
                    <form action="{{ url_for('payments.cancel_order', order_id=order.id) }}" method="POST">
                        {{ csrf_token() }}
                        <button type="submit" onclick="return confirm('Are you sure you want to cancel this order?');"
                                class="w-full inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                            <i class="fas fa-times-circle mr-2"></i> Cancel Order
                        </button>
                    </form>
                {% endif %}
            {% elif current_user.id == order.seller.id %}
                <!-- Seller Actions -->
                {% if order.status == 'paid' %}
                    <form action="{{ url_for('payments.mark_picked_up', order_id=order.id) }}" method="POST">
                        {{ csrf_token() }}
                        <button type="submit" class="w-full inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            <i class="fas fa-box-open mr-2"></i> Mark as Ready for Pickup/Shipped
                        </button>
                    </form>
                {% elif order.status == 'pending_pickup' %}
                     <form action="{{ url_for('payments.complete_order', order_id=order.id) }}" method="POST">
                        {{ csrf_token() }}
                        <button type="submit" class="w-full inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                            <i class="fas fa-check-circle mr-2"></i> Confirm Item Delivered
                        </button>
                    </form>
                {% endif %}
                 {% if order.status in ['pending_payment', 'paid', 'pending_pickup'] %}
                    <form action="{{ url_for('payments.cancel_order', order_id=order.id) }}" method="POST">
                        {{ csrf_token() }}
                        <button type="submit" onclick="return confirm('Are you sure you want to cancel this order?');"
                                class="w-full inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                            <i class="fas fa-times-circle mr-2"></i> Cancel Order
                        </button>
                    </form>
                {% endif %}
            {% endif %}
        </div>
        <div class="mt-8 text-center">
            <a href="{{ url_for('payments.manage_orders') }}" class="text-indigo-600 hover:text-indigo-800 font-medium">
                &larr; Back to All Orders
            </a>
        </div>
    </div>
</div>
{% endblock %}
