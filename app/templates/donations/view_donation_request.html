{% extends '_layouts/base.html' %}
{% import 'macros.html' as macros %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-2xl">
    <div class="bg-white p-8 rounded-lg shadow-xl border border-gray-200">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Donation Details</h1>

        <div class="mb-8 p-4 bg-gray-50 rounded-md border border-gray-100">
            <p class="text-lg font-semibold text-gray-700 mb-2">Item: <span class="text-indigo-600">{{ donation.donated_listing.title }}</span></p>
            <div class="flex items-center space-x-4 mb-4">
                <img src="{{ donation.donated_listing.images[0] }}" alt="{{ donation.donated_listing.title }}" class="w-24 h-24 object-cover rounded-md shadow-md">
                <div>
                    <p class="text-sm text-gray-600">Size: {{ donation.donated_listing.size }}</p>
                    <p class="text-sm text-gray-600">Condition: {{ donation.donated_listing.condition }}</p>
                    <p class="text-sm text-gray-600">Category: {{ donation.donated_listing.category }}</p>
                    {% if donation.donated_listing.school_name %}<p class="text-sm text-gray-600">School: {{ donation.donated_listing.school_name }}</p>{% endif %}
                </div>
            </div>
            <p class="text-sm text-gray-700 mb-2">Description: {{ donation.donated_listing.description }}</p>
        </div>

        <div class="mb-8 p-4 bg-blue-50 rounded-md border border-blue-100">
            <h2 class="text-xl font-semibold text-blue-800 mb-3">Donation Request Details</h2>
            <p class="text-md text-gray-700 mb-2">Donor: <span class="font-medium">{{ donation.donor.username }}</span></p>
            <p class="text-md text-gray-700 mb-2">Recipient: <span class="font-medium">{{ donation.recipient.username }}</span></p>
            <p class="text-md text-gray-700 mb-2">Status: 
                <span class="font-bold {% if donation.status == 'pending_pickup' %}text-yellow-600{% elif donation.status == 'received' %}text-blue-600{% elif donation.status == 'distributed' %}text-green-600{% endif %}">
                    {{ donation.status|replace('_', ' ')|capitalize }}
                </span>
            </p>
            <p class="text-sm text-gray-600">Proposed on: {{ moment(donation.donation_date).format('MMMM Do YYYY, h:mm a') }}</p>
            {% if donation.updated_date %}<p class="text-sm text-gray-600">Last Updated: {{ moment(donation.updated_date).format('MMMM Do YYYY, h:mm a') }}</p>{% endif %}
            {% if donation.notes %}<p class="text-md text-gray-700 mt-2">Notes: {{ donation.notes }}</p>{% endif %}
        </div>

        <!-- Actions for Recipient (School/NGO) -->
        {% if current_user.id == donation.recipient.id %}
            {% if donation.status == 'pending_pickup' %}
            <div class="bg-yellow-50 p-6 rounded-lg shadow-md border border-yellow-200 mt-6">
                <h2 class="text-xl font-semibold text-yellow-800 mb-4">Confirm Donation Receipt</h2>
                <form method="POST" action="{{ url_for('donations.confirm_receipt', donation_id=donation.id) }}">
                    {{ confirm_form.csrf_token }}
                    {{ macros.render_field(confirm_form.notes, class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm") }}
                    {{ confirm_form.submit(class="mt-4 w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500") }}
                </form>
            </div>
            {% elif donation.status == 'received' %}
            <div class="bg-blue-50 p-6 rounded-lg shadow-md border border-blue-200 mt-6">
                <h2 class="text-xl font-semibold text-blue-800 mb-4">Mark as Distributed</h2>
                <form method="POST" action="{{ url_for('donations.mark_distributed', donation_id=donation.id) }}">
                    {{ distribute_form.csrf_token }}
                    {{ macros.render_field(distribute_form.distribution_notes, class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm") }}
                    {{ distribute_form.submit(class="mt-4 w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500") }}
                </form>
            </div>
            {% endif %}
        {% endif %}

        <!-- Actions for Donor (Parent) - e.g., Cancel if not picked up -->
        {% if current_user.id == donation.donor.id and donation.status == 'pending_pickup' %}
            <div class="mt-6 text-center">
                <form method="POST" action="{{ url_for('donations.cancel_donation', donation_id=donation.id) }}">
                    <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                        Cancel Donation
                    </button>
                </form>
            </div>
        {% endif %}

    </div>
</div>
{% endblock %}
