{% extends '_layouts/base.html' %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-gray-800 mb-6 rounded-lg p-3 bg-indigo-100 shadow-md text-center">
        Parent Dashboard
    </h1>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- My Listings Section -->
        <div class="bg-white p-6 rounded-lg shadow-lg border border-gray-200">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                My Listings
            </h2>
            <p class="text-gray-600 mb-4">View and manage items you've listed for swap, sale, or donation.</p>
            <a href="{{ url_for('listings.parent_dashboard') }}" class="inline-block bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                View My Listings
            </a>
            <p class="text-sm text-gray-500 mt-2">({{ user_listings|length if user_listings else 0 }} active listings)</p>
            {% if user_listings %}
                <ul class="mt-4 space-y-2">
                    {% for listing in user_listings|slice(':3') %} {# Show first 3 listings #}
                        <li class="flex items-center bg-gray-50 p-3 rounded-md shadow-sm">
                            <img src="{{ listing.images[0] }}" alt="{{ listing.title }}" class="h-10 w-10 object-cover rounded-md mr-3">
                            <div>
                                <a href="{{ url_for('listings.listing_detail', listing_id=listing.id) }}" class="text-indigo-600 hover:underline font-medium">{{ listing.title }}</a>
                                <p class="text-sm text-gray-500">{{ listing.listing_type|capitalize }} - {{ listing.status|capitalize }}</p>
                            </div>
                        </li>
                    {% endfor %}
                    {% if user_listings|length > 3 %}
                        <li class="text-center mt-3">
                            <a href="{{ url_for('listings.parent_dashboard') }}" class="text-indigo-500 hover:underline text-sm">View All My Listings &rarr;</a>
                        </li>
                    {% endif %}
                </ul>
            {% else %}
                <p class="text-gray-500 text-sm">You haven't listed any items yet.</p>
                <a href="{{ url_for('listings.create_listing') }}" class="mt-4 inline-block bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                    Create New Listing
                </a>
            {% endif %}
        </div>

        <!-- My Swap & Buy Activity Section -->
        <div class="bg-white p-6 rounded-lg shadow-lg border border-gray-200">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                </svg>
                My Swap & Buy Activity
            </h2>
            <p class="text-gray-600 mb-4">Track the status of your swap offers, requests, purchases and donations.</p>
            <a href="{{ url_for('swaps.manage_swaps') }}" class="inline-block bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                Manage Swaps
            </a>
            <a href="{{ url_for('payments.manage_orders') }}" class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ml-2">
                Manage Orders
            </a>
            <a href="{{ url_for('donations.manage_donations') }}" class="inline-block bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ml-2">
                Manage Donations
            </a>

            <ul class="mt-4 space-y-2 text-gray-600">
                <li class="flex items-center">
                    <span class="font-medium mr-2">Pending Swaps:</span> <span class="text-yellow-600 font-bold">{{ pending_swaps|length }}</span>
                </li>
                <li class="flex items-center">
                    <span class="font-medium mr-2">Accepted Swaps:</span> <span class="text-blue-600 font-bold">{{ accepted_swaps|length }}</span>
                </li>
                <li class="flex items-center">
                    <span class="font-medium mr-2">Completed Swaps:</span> <span class="text-green-600 font-bold">{{ completed_swaps|length }}</span>
                </li>
                <li class="flex items-center">
                    <span class="font-medium mr-2">Items Purchased:</span> <span class="text-blue-600 font-bold">{{ bought_items|length }}</span>
                </li>
                <li class="flex items-center">
                    <span class="font-medium mr-2">Items Sold:</span> <span class="text-green-600 font-bold">{{ sold_items|length }}</span>
                </li>
                <li class="flex items-center">
                    <span class="font-medium mr-2">Items Donated:</span> <span class="text-purple-600 font-bold">{{ sent_donations|length }}</span>
                </li>
            </ul>

            <h3 class="text-xl font-semibold text-gray-700 mt-6 mb-3">Logistics Status Overview</h3>
            <ul class="space-y-2 text-gray-600">
                {% for order in bought_items %}
                    {% if order.logistics_status != 'delivered' and order.logistics_status != 'failed' %}
                        <li class="flex items-center justify-between bg-gray-100 p-2 rounded-md">
                            <span class="text-sm">Order for "{{ order.purchased_listing.title }}" (Buyer)</span>
                            <a href="{{ url_for('logistics.view_logistics', transaction_type='order', transaction_id=order.id) }}" class="text-blue-500 hover:underline text-sm">
                                Status: {{ order.logistics_status|replace('_', ' ')|capitalize }} &rarr;
                            </a>
                        </li>
                    {% endif %}
                {% endfor %}
                {% for order in sold_items %}
                    {% if order.logistics_status != 'delivered' and order.logistics_status != 'failed' %}
                        <li class="flex items-center justify-between bg-gray-100 p-2 rounded-md">
                            <span class="text-sm">Order for "{{ order.purchased_listing.title }}" (Seller)</span>
                            <a href="{{ url_for('logistics.view_logistics', transaction_type='order', transaction_id=order.id) }}" class="text-blue-500 hover:underline text-sm">
                                Status: {{ order.logistics_status|replace('_', ' ')|capitalize }} &rarr;
                            </a>
                        </li>
                    {% endif %}
                {% endfor %}
                {% for swap in pending_swaps + accepted_swaps %} {# Include both pending and accepted swaps #}
                    {% if swap.logistics_status != 'delivered' and swap.logistics_status != 'failed' %}
                        <li class="flex items-center justify-between bg-gray-100 p-2 rounded-md">
                            <span class="text-sm">Swap for "{{ swap.responder_listing.title }}"</span>
                            <a href="{{ url_for('logistics.view_logistics', transaction_type='swap', transaction_id=swap.id) }}" class="text-blue-500 hover:underline text-sm">
                                Status: {{ swap.logistics_status|replace('_', ' ')|capitalize }} &rarr;
                            </a>
                        </li>
                    {% endif %}
                {% endfor %}
                {% for donation in sent_donations %}
                    {% if donation.logistics_status != 'delivered' and donation.logistics_status != 'failed' %}
                        <li class="flex items-center justify-between bg-gray-100 p-2 rounded-md">
                            <span class="text-sm">Donation of "{{ donation.donated_listing.title }}"</span>
                            <a href="{{ url_for('logistics.view_logistics', transaction_type='donation', transaction_id=donation.id) }}" class="text-blue-500 hover:underline text-sm">
                                Status: {{ donation.logistics_status|replace('_', ' ')|capitalize }} &rarr;
                            </a>
                        </li>
                    {% endif %}
                {% endfor %}
                {% if not bought_items and not sold_items and not pending_swaps and not accepted_swaps and not sent_donations %}
                    <li class="text-gray-500 text-sm">No active logistics to track.</li>
                {% endif %}
            </ul>
        </div>

        <!-- My Account & Payments Section -->
        <div class="bg-white p-6 rounded-lg shadow-lg border border-gray-200">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                Account & Payments
            </h2>
            <p class="text-gray-600 mb-4">Manage your profile, payment methods, and transaction history.</p>
            <a href="{{ url_for('profile.edit_profile') }}" class="inline-block bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                View Profile
            </a>
            <ul class="mt-4 space-y-2 text-gray-600">
                {# These would be dynamic based on actual payment processing and user wallet #}
                <li class="flex items-center">
                    <span class="font-medium mr-2">Wallet Balance:</span> <span class="text-gray-800 font-bold">R 0.00</span>
                </li>
                <li class="flex items-center">
                    <span class="font-medium mr-2">Total Sales:</span> <span class="text-green-600 font-bold">R {{ "%.2f" | format(sold_items|sum(attribute='price_at_purchase')) }}</span>
                </li>
                <li class="flex items-center">
                    <span class="font-medium mr-2">Total Purchases:</span> <span class="text-red-600 font-bold">R {{ "%.2f" | format(bought_items|sum(attribute='price_at_purchase')) }}</span>
                </li>
            </ul>
            <p class="text-sm text-gray-500 mt-2">Payment integration (e.g., PayFast/PayPal) coming soon.</p>
        </div>
    </div>
</div>
{% endblock %}
