{% extends "_layouts/base.html" %}

{% block title %}
    Your Inbox
{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="display-4">Your Inbox</h1>
            <p class="lead text-muted">Manage all your messages in one place.</p>
        </div>
    </div>

    <hr>
    
    {% if messages_by_listing %}
        <div class="row">
            {% for listing_id, conversation in messages_by_listing.items() %}
                <div class="col-12 mb-5">
                    <div class="card bg-secondary rounded shadow">
                        <div class="card-header bg-dark text-white-50">
                            Conversation about: <a href="{{ url_for('listings_bp.listing_detail', listing_id=listing_id) }}" class="text-decoration-none text-info">{{ conversation[0].listing_info.title }}</a>
                        </div>
                        <div class="card-body bg-secondary text-white-50">
                            <div class="list-group list-group-flush">
                                {% for message in conversation %}
                                    <div class="list-group-item bg-secondary text-white-50 border-bottom border-secondary">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h6 class="mb-1 text-white">
                                                {% if message.sender_info._id|string == user._id|string %}
                                                    <span class="fw-bold">You</span>
                                                {% else %}
                                                    <span class="fw-bold">{{ message.sender_info.name }}</span>
                                                {% endif %}
                                            </h6>
                                            <small class="text-white-50">
                                                {{ message.created_at.strftime('%B %d, %Y at %I:%M %p') }}
                                            </small>
                                        </div>
                                        <p class="mb-1">{{ message.content }}</p>
                                    </div>
                                {% endfor %}
                            </div>

                            <!-- Reply Form -->
                            <div class="mt-3">
                                <form action="{{ url_for('messaging_bp.send_message', listing_id=listing_id) }}" method="POST">
                                    <div class="mb-3">
                                        <label for="replyContent-{{ listing_id }}" class="form-label text-white">Your Reply</label>
                                        <textarea name="content" id="replyContent-{{ listing_id }}" class="form-control" rows="3" required></textarea>
                                    </div>
                                    <div class="d-grid">
                                        <input type="hidden" name="receiver_id" value="{{ conversation[0].sender_info._id }}">
                                        <button type="submit" class="btn btn-success">Send Reply</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p class="lead text-center mt-5">Your inbox is empty.</p>
    {% endif %}
{% endblock %}
