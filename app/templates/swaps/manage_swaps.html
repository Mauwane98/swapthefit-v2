{% extends "_layouts/base.html" %}

{% block title %}Manage Swaps{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="text-center mb-5">
        <h1 class="display-5 fw-bold">Manage Your Swaps</h1>
        <p class="lead">Track your incoming and outgoing swap requests.</p>
    </div>

    <div class="row">
        <!-- Incoming Swap Requests Section -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body p-4">
                    <h4 class="card-title fw-bold mb-3">Incoming Swap Requests</h4>
                    {% if incoming_swaps %}
                        <ul class="list-group list-group-flush">
                            {% for request in incoming_swaps %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">From: {{ request.proposer.username }}</h6>
                                    <small class="text-muted">For your: <a href="{{ url_for('listings.listing_detail', listing_id=request.requested_listing.id) }}">{{ request.requested_listing.title }}</a></small><br>
                                    <small class="text-muted">Status: <span class="badge 
                                        {% if request.status == 'pending' %}bg-warning text-dark
                                        {% elif request.status == 'accepted' %}bg-success
                                        {% elif request.status == 'rejected' or request.status == 'cancelled' %}bg-danger
                                        {% endif %}">{{ request.status|capitalize }}</span></small>
                                </div>
                                <div>
                                    <a href="{{ url_for('swaps.view_swap_request', request_id=request.id) }}" class="btn btn-sm btn-secondary">View Details</a>
                                    {% if request.status == 'pending' %}
                                        <form action="{{ url_for('swaps.respond_swap', request_id=request.id, action='accept') }}" method="POST" class="d-inline">
                                            {{ csrf_token() | safe }}
                                            <button type="submit" class="btn btn-sm btn-success">Accept</button>
                                        </form>
                                        <form action="{{ url_for('swaps.respond_swap', request_id=request.id, action='reject') }}" method="POST" class="d-inline">
                                            {{ csrf_token() | safe }}
                                            <button type="submit" class="btn btn-sm btn-danger">Reject</button>
                                        </form>
                                    {% endif %}
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted">No incoming swap requests at the moment.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Outgoing Swap Requests Section -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body p-4">
                    <h4 class="card-title fw-bold mb-3">Your Proposed Swaps</h4>
                    {% if outgoing_swaps %}
                        <ul class="list-group list-group-flush">
                            {% for request in outgoing_swaps %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">To: {{ request.recipient.username }}</h6>
                                    <small class="text-muted">Your: <a href="{{ url_for('listings.listing_detail', listing_id=request.offered_listing.id) }}">{{ request.offered_listing.title }}</a> for their: <a href="{{ url_for('listings.listing_detail', listing_id=request.requested_listing.id) }}">{{ request.requested_listing.title }}</a></small><br>
                                    <small class="text-muted">Status: <span class="badge 
                                        {% if request.status == 'pending' %}bg-warning text-dark
                                        {% elif request.status == 'accepted' %}bg-success
                                        {% elif request.status == 'declined' %}bg-danger
                                        {% elif request.status == 'completed' %}bg-info
                                        {% else %}
                                            <span class="badge bg-secondary">{{ request.status.capitalize() }}</span>
                                        {% endif %}
                                    </small>
                                </div>
                                <div>
                                    <a href="{{ url_for('swaps.view_swap_request', request_id=request.id) }}" class="btn btn-sm btn-secondary">View Details</a>
                                    {% if request.status == 'pending' %}
                                        <form action="{{ url_for('swaps.respond_swap', request_id=request.id, action='cancel') }}" method="POST" class="d-inline">
                                            {{ csrf_token() | safe }}
                                            <button type="submit" class="btn btn-sm btn-danger">Cancel Request</button>
                                        </form>
                                    {% endif %}
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted">You haven't proposed any swaps yet.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}