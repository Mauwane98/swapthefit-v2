{% extends '_layouts/base.html' %}
{% import 'macros.html' as macros %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-2xl">
    <div class="bg-white p-8 rounded-lg shadow-xl border border-gray-200">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Logistics Details</h1>

        <div class="mb-8 p-4 bg-gray-50 rounded-md border border-gray-100">
            <h2 class="text-xl font-semibold text-gray-700 mb-3">Item Details:</h2>
            <div class="flex items-center space-x-4 mb-4">
                {% if transaction_type == 'order' %}
                    <img src="{{ transaction.purchased_listing.images[0] }}" alt="{{ transaction.purchased_listing.title }}" class="w-24 h-24 object-cover rounded-md shadow-md">
                    <div>
                        <p class="text-lg font-medium text-gray-800">{{ transaction.purchased_listing.title }}</p>
                        <p class="text-sm text-gray-600">Category: {{ transaction.purchased_listing.category }} | Size: {{ transaction.purchased_listing.size }}</p>
                        <p class="text-sm text-gray-600">Seller: {{ transaction.seller.username }} | Buyer: {{ transaction.buyer.username }}</p>
                        <p class="text-sm text-gray-600 font-bold text-green-700">Price: R {{ "%.2f" | format(transaction.price_at_purchase) }}</p>
                    </div>
                {% elif transaction_type == 'swap' %}
                    <img src="{{ transaction.responder_listing.images[0] }}" alt="{{ transaction.responder_listing.title }}" class="w-24 h-24 object-cover rounded-md shadow-md">
                    <div>
                        <p class="text-lg font-medium text-gray-800">Your Item: {{ transaction.requester_listing.title }}</p>
                        <p class="text-lg font-medium text-gray-800">Desired Item: {{ transaction.responder_listing.title }}</p>
                        <p class="text-sm text-gray-600">Requester: {{ transaction.requester.username }} | Responder: {{ transaction.responder.username }}</p>
                    </div>
                {% elif transaction_type == 'donation' %}
                    <img src="{{ transaction.donated_listing.images[0] }}" alt="{{ transaction.donated_listing.title }}" class="w-24 h-24 object-cover rounded-md shadow-md">
                    <div>
                        <p class="text-lg font-medium text-gray-800">{{ transaction.donated_listing.title }}</p>
                        <p class="text-sm text-gray-600">Category: {{ transaction.donated_listing.category }} | Size: {{ transaction.donated_listing.size }}</p>
                        <p class="text-sm text-gray-600">Donor: {{ transaction.donor.username }} | Recipient: {{ transaction.recipient.username }}</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="mb-8 p-4 bg-blue-50 rounded-md border border-blue-100">
            <h2 class="text-xl font-semibold text-blue-800 mb-3">Logistics Information</h2>
            <p class="text-md text-gray-700 mb-2">Delivery Method: <span class="font-medium">{{ transaction.delivery_method|replace('_', ' ')|capitalize if transaction.delivery_method else 'N/A' }}</span></p>
            <p class="text-md text-gray-700 mb-2">Current Status: 
                <span class="font-bold {% if transaction.logistics_status == 'awaiting_setup' %}text-gray-600{% elif transaction.logistics_status == 'awaiting_pickup' %}text-yellow-600{% elif transaction.logistics_status == 'in_transit' or transaction.logistics_status == 'ready_for_collection' %}text-blue-600{% elif transaction.logistics_status == 'delivered' %}text-green-600{% elif transaction.logistics_status == 'failed' %}text-red-600{% endif %}">
                    {{ transaction.logistics_status|replace('_', ' ')|capitalize }}
                </span>
            </p>
            {% if transaction.logistics_provider %}<p class="text-md text-gray-700 mb-2">Provider: <span class="font-medium">{{ transaction.logistics_provider }}</span></p>{% endif %}
            {% if transaction.tracking_number %}<p class="text-md text-gray-700 mb-2">Tracking Number: <span class="font-medium">{{ transaction.tracking_number }}</span></p>{% endif %}
            {% if transaction.pickup_location_details %}<p class="text-md text-gray-700 mb-2">Pickup Details: <span class="font-medium">{{ transaction.pickup_location_details }}</span></p>{% endif %}
            {% if transaction.delivery_address_details %}<p class="text-md text-gray-700 mb-2">Delivery Address: <span class="font-medium">{{ transaction.delivery_address_details }}</span></p>{% endif %}
            <p class="text-sm text-gray-600">Last Updated: {{ moment(transaction.updated_date).format('MMMM Do YYYY, h:mm a') }}</p>
        </div>

        <!-- Actions for updating logistics status -->
        {% if current_user.is_authenticated and transaction.logistics_status not in ['delivered', 'failed'] %}
            <div class="bg-gray-50 p-6 rounded-lg shadow-md border border-gray-200 mt-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Update Logistics Status</h2>
                <form method="POST" action="{{ url_for('logistics.update_logistics_status', transaction_type=transaction_type, transaction_id=transaction.id) }}" class="space-y-4">
                    {{ update_form.csrf_token }}
                    
                    {% if transaction.logistics_status in ['awaiting_setup', 'awaiting_pickup'] %}
                        <div>
                            {{ macros.render_field(update_form.tracking_number, class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm") }}
                        </div>
                        {{ update_form.submit_shipped(class="mt-4 w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500") }}
                    {% elif transaction.logistics_status in ['in_transit', 'ready_for_collection'] %}
                        {{ update_form.submit_received(class="mt-4 w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500") }}
                    {% endif %}

                    {% if transaction.logistics_status not in ['delivered', 'failed'] %}
                        <button type="submit" name="submit_cancel_logistics" value="Cancel Logistics" 
                                class="mt-2 w-full inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                            <i class="fas fa-times-circle mr-2"></i> Cancel Logistics
                        </button>
                    {% endif %}
                </form>
            </div>
        {% endif %}

        <div class="mt-8 text-center">
            {% if transaction_type == 'order' %}
                <a href="{{ url_for('payments.view_order', order_id=transaction.id) }}" class="text-indigo-600 hover:text-indigo-800 font-medium">
                    &larr; Back to Order Details
                </a>
            {% elif transaction_type == 'swap' %}
                <a href="{{ url_for('swaps.view_swap_request', swap_request_id=transaction.id) }}" class="text-indigo-600 hover:text-indigo-800 font-medium">
                    &larr; Back to Swap Request
                </a>
            {% elif transaction_type == 'donation' %}
                <a href="{{ url_for('donations.view_donation_request', donation_id=transaction.id) }}" class="text-indigo-600 hover:text-indigo-800 font-medium">
                    &larr; Back to Donation Request
                </a>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
