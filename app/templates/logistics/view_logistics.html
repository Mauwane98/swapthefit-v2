{% extends "_layouts/base.html" %}

{% block title %}Logistics Details{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-lg border-0">
                <div class="card-body p-5">
                    <h1 class="h3 fw-bold text-center mb-4">Logistics Details</h1>

                    <div class="mb-4">
                        <h2 class="h5 fw-bold">Transaction Overview</h2>
                        <dl class="row">
                            <dt class="col-sm-4">Transaction ID:</dt>
                            <dd class="col-sm-8">{{ logistics.transaction_id }}</dd>

                            <dt class="col-sm-4">Transaction Type:</dt>
                            <dd class="col-sm-8">{{ logistics.transaction_type|capitalize }}</dd>

                            <dt class="col-sm-4">Sender:</dt>
                            <dd class="col-sm-8"><a href="{{ url_for('listings.user_profile', user_id=logistics.sender.id) }}">{{ logistics.sender.username }}</a></dd>

                            <dt class="col-sm-4">Receiver:</dt>
                            <dd class="col-sm-8"><a href="{{ url_for('listings.user_profile', user_id=logistics.receiver.id) }}">{{ logistics.receiver.username }}</a></dd>

                            {% if related_listing %}
                            <dt class="col-sm-4">Related Listing:</dt>
                            <dd class="col-sm-8"><a href="{{ url_for('listings.listing_detail', listing_id=related_listing.id) }}">{{ related_listing.title }}</a></dd>
                            {% endif %}
                        </dl>
                    </div>

                    <div class="mb-4">
                        <h2 class="h5 fw-bold">Shipping Details</h2>
                        <dl class="row">
                            <dt class="col-sm-4">Method:</dt>
                            <dd class="col-sm-8">{{ logistics.shipping_method|replace('_', ' ')|title }}</dd>

                            <dt class="col-sm-4">Current Status:</dt>
                            <dd class="col-sm-8">
                                <span class="badge 
                                    {% if logistics.status == 'delivered' %}bg-success
                                    {% elif logistics.status == 'in_transit' %}bg-info
                                    {% elif logistics.status == 'pending_pickup' or logistics.status == 'ready_for_collection' %}bg-warning text-dark
                                    {% else %}bg-secondary{% endif %}">
                                    {{ logistics.status|replace('_', ' ')|title }}
                                </span>
                            </dd>

                            {% if logistics.courier_name %}
                            <dt class="col-sm-4">Courier:</dt>
                            <dd class="col-sm-8">{{ logistics.courier_name }}</dd>
                            {% endif %}

                            {% if logistics.tracking_number %}
                            <dt class="col-sm-4">Tracking No.:</dt>
                            <dd class="col-sm-8">
                                {% if logistics.tracking_url %}
                                    <a href="{{ logistics.tracking_url }}" target="_blank">{{ logistics.tracking_number }}</a>
                                {% else %}
                                    {{ logistics.tracking_number }}
                                {% endif %}
                            </dd>
                            {% endif %}

                            {% if logistics.pudo_location_name %}
                            <dt class="col-sm-4">PUDO Location:</dt>
                            <dd class="col-sm-8">{{ logistics.pudo_location_name }}</dd>
                            {% endif %}

                            {% if logistics.pudo_address %}
                            <dt class="col-sm-4">PUDO Address:</dt>
                            <dd class="col-sm-8">{{ logistics.pudo_address }}</dd>
                            {% endif %}

                            {% if logistics.pudo_code %}
                            <dt class="col-sm-4">PUDO Code:</dt>
                            <dd class="col-sm-8">{{ logistics.pudo_code }}</dd>
                            {% endif %}

                            {% if logistics.pickup_address %}
                            <dt class="col-sm-4">Pickup Address:</dt>
                            <dd class="col-sm-8">{{ logistics.pickup_address }}</dd>
                            {% endif %}

                            {% if logistics.delivery_address %}
                            <dt class="col-sm-4">Delivery Address:</dt>
                            <dd class="col-sm-8">{{ logistics.delivery_address }}</dd>
                            {% endif %}

                            <dt class="col-sm-4">Created At:</dt>
                            <dd class="col-sm-8">{{ logistics.created_at.strftime('%b %d, %Y %I:%M %p') }}</dd>

                            <dt class="col-sm-4">Last Updated:</dt>
                            <dd class="col-sm-8">{{ logistics.last_status_update.strftime('%b %d, %Y %I:%M %p') }}</dd>

                            {% if logistics.scheduled_pickup_date %}
                            <dt class="col-sm-4">Scheduled Pickup:</dt>
                            <dd class="col-sm-8">{{ logistics.scheduled_pickup_date.strftime('%b %d, %Y %I:%M %p') }}</dd>
                            {% endif %}

                            {% if logistics.actual_pickup_date %}
                            <dt class="col-sm-4">Actual Pickup:</dt>
                            <dd class="col-sm-8">{{ logistics.actual_pickup_date.strftime('%b %d, %Y %I:%M %p') }}</dd>
                            {% endif %}

                            {% if logistics.scheduled_delivery_date %}
                            <dt class="col-sm-4">Scheduled Delivery:</dt>
                            <dd class="col-sm-8">{{ logistics.scheduled_delivery_date.strftime('%b %d, %Y %I:%M %p') }}</dd>
                            {% endif %}

                            {% if logistics.actual_delivery_date %}
                            <dt class="col-sm-4">Actual Delivery:</dt>
                            <dd class="col-sm-8">{{ logistics.actual_delivery_date.strftime('%b %d, %Y %I:%M %p') }}</dd>
                            {% endif %}

                            {% if logistics.notes %}
                            <dt class="col-sm-4">Notes:</dt>
                            <dd class="col-sm-8">{{ logistics.notes }}</dd>
                            {% endif %}
                        </dl>
                    </div>

                    {% if current_user.id == logistics.sender_user_id or current_user.id == logistics.receiver_user_id or current_user.role == 'admin' %}
                    <div class="mt-4 pt-4 border-top">
                        <h2 class="h5 fw-bold">Update Status</h2>
                        <form method="POST" action="{{ url_for('logistics.update_logistics_status', logistics_id=logistics.id) }}">
                            {{ update_form.hidden_tag() }}
                            
                            <div class="mb-3">
                                {{ update_form.status.label(class="form-label") }}
                                {{ update_form.status(class="form-select form-select-lg") }}
                                {% for error in update_form.status.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            </div>

                            <div class="row g-3">
                                <div class="col-md-6 mb-3">
                                    {{ update_form.actual_pickup_date.label(class="form-label") }}
                                    {{ update_form.actual_pickup_date(class="form-control form-control-lg") }}
                                    {% for error in update_form.actual_pickup_date.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    {{ update_form.actual_delivery_date.label(class="form-label") }}
                                    {{ update_form.actual_delivery_date(class="form-control form-control-lg") }}
                                    {% for error in update_form.actual_delivery_date.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="mb-3">
                                {{ update_form.notes.label(class="form-label") }}
                                {{ update_form.notes(class="form-control form-control-lg", rows="5") }}
                                {% for error in update_form.notes.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            </div>

                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary btn-lg">Update Status</button>
                            </div>
                        </form>
                    </div>
                    {% endif %}

                    <div class="mt-4 text-center">
                        <a href="{{ url_for('listings.dashboard') }}" class="btn btn-secondary">Back to Dashboard</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}